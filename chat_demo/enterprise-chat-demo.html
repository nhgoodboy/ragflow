<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¼ä¸šç³»ç»Ÿ - RAGFlow èŠå¤©é›†æˆç¤ºä¾‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #1890ff;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        
        .content {
            display: flex;
            height: calc(100vh - 64px);
        }
        
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e8e8e8;
            padding: 20px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-container {
            flex: 1;
            background: #fafbfc;
            position: relative;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .user-list {
            list-style: none;
        }
        
        .user-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }
        
        .user-item:hover {
            background: #f0f0f0;
        }
        
        .user-item.active {
            background: #e6f7ff;
            border-color: #1890ff;
        }
        
        .user-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .user-id {
            font-size: 12px;
            color: #999;
        }
        
        .section-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: #262626;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .error {
            color: #ff4d4f;
            background: #fff2f0;
            border: 1px solid #ffccc7;
            padding: 12px;
            border-radius: 6px;
            margin: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ä¼ä¸šæ™ºèƒ½åŠ©æ‰‹ç³»ç»Ÿ</div>
        <div class="user-info">
            <span>å½“å‰ç”¨æˆ·:</span>
            <span id="current-user-name">è¯·é€‰æ‹©ç”¨æˆ·</span>
            <button class="btn btn-primary" onclick="refreshChat()">åˆ·æ–°èŠå¤©</button>
        </div>
    </div>
    
    <div class="content">
        <div class="sidebar">
            <h3 class="section-title">ç”¨æˆ·åˆ—è¡¨</h3>
            <ul class="user-list" id="user-list">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </ul>
        </div>
        
        <div class="main-content">
            <div class="chat-header">
                <div>
                    <h3 id="chat-title">RAGFlow æ™ºèƒ½åŠ©æ‰‹</h3>
                    <p id="chat-subtitle">è¯·é€‰æ‹©ç”¨æˆ·å¼€å§‹èŠå¤©</p>
                </div>
                <div id="session-info" style="font-size: 12px; color: #999;"></div>
            </div>
            
            <div class="chat-container" id="chat-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½èŠå¤©çª—å£...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CONFIG = {
            baseURL: 'http://sz.safewaychina.cn:7080',
            apiKey: 'YOUR_API_KEY',           // éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIå¯†é’¥
            chatId: 'YOUR_CHAT_ID',           // éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„èŠå¤©åŠ©æ‰‹ID
            auth: 'UzOTkwZmEyM2NmYzExZjA4MDE1ZmFjYT' // ç°æœ‰çš„auth token
        };

        // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
        const USERS = [
            { id: 'user_001', name: 'å¼ ä¸‰', department: 'æŠ€æœ¯éƒ¨' },
            { id: 'user_002', name: 'æå››', department: 'å¸‚åœºéƒ¨' },
            { id: 'user_003', name: 'ç‹äº”', department: 'é”€å”®éƒ¨' },
            { id: 'user_004', name: 'èµµå…­', department: 'äººäº‹éƒ¨' },
            { id: 'user_005', name: 'é’±ä¸ƒ', department: 'è´¢åŠ¡éƒ¨' }
        ];

        let currentUser = null;
        let chatIntegration = null;

        // ç®€åŒ–ç‰ˆçš„èŠå¤©é›†æˆç±»
        class SimpleChatIntegration {
            constructor(config) {
                this.baseURL = config.baseURL;
                this.apiKey = config.apiKey;
                this.chatId = config.chatId;
                this.auth = config.auth;
            }

            async createUserSession(userId, userName) {
                try {
                    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ç°æœ‰çš„shared_idä½œä¸ºç¤ºä¾‹
                    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦è°ƒç”¨APIåˆ›å»ºæ–°ä¼šè¯
                    console.log(`ä¸ºç”¨æˆ· ${userName}(${userId}) åˆ›å»ºä¼šè¯`);
                    
                    // æ¨¡æ‹ŸAPIè°ƒç”¨
                    return {
                        success: true,
                        sessionId: `session_${userId}_${Date.now()}`,
                        sessionName: `${userName}çš„ä¼šè¯`
                    };
                } catch (error) {
                    console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }
            }

            generateUserChatURL(userId, sessionId = null) {
                // ä¸ºæ¼”ç¤ºç›®çš„ï¼Œä½¿ç”¨ç°æœ‰çš„shared_id
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·åº”è¯¥æœ‰ç‹¬ç«‹çš„sessionId
                const actualSessionId = sessionId || 'c23776c03cfa11f08a28faca3d0be991';
                return `${this.baseURL}/chat/share?shared_id=${actualSessionId}&from=chat&auth=${this.auth}&user_id=${userId}`;
            }

            async embedUserChat(containerId, userId, userName) {
                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const container = document.getElementById(containerId);
                    container.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>æ­£åœ¨ä¸º ${userName} åŠ è½½èŠå¤©çª—å£...</div>
                        </div>
                    `;

                    // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // ç”ŸæˆèŠå¤©URL
                    const chatURL = this.generateUserChatURL(userId);
                    
                    container.innerHTML = `
                        <iframe
                            src="${chatURL}"
                            style="width: 100%; height: 100%; border: none;"
                            frameborder="0"
                            title="${userName}çš„èŠå¤©çª—å£"
                        ></iframe>
                    `;
                    
                    return chatURL;
                } catch (error) {
                    console.error('åµŒå…¥èŠå¤©çª—å£å¤±è´¥:', error);
                    
                    const container = document.getElementById(containerId);
                    container.innerHTML = `
                        <div class="error">
                            èŠå¤©çª—å£åŠ è½½å¤±è´¥: ${error.message}
                            <br><br>
                            <button class="btn btn-primary" onclick="switchUser('${userId}')">é‡è¯•</button>
                        </div>
                    `;
                    throw error;
                }
            }
        }

        // åˆå§‹åŒ–
        function init() {
            chatIntegration = new SimpleChatIntegration(CONFIG);
            renderUserList();
            
            // é»˜è®¤æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
            document.getElementById('chat-container').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¬</div>
                    <h3>æ¬¢è¿ä½¿ç”¨ä¼ä¸šæ™ºèƒ½åŠ©æ‰‹</h3>
                    <p>è¯·ä»å·¦ä¾§é€‰æ‹©ç”¨æˆ·å¼€å§‹èŠå¤©</p>
                </div>
            `;
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUserList() {
            const userList = document.getElementById('user-list');
            userList.innerHTML = USERS.map(user => `
                <li class="user-item" onclick="switchUser('${user.id}')">
                    <div class="user-name">${user.name}</div>
                    <div class="user-id">ID: ${user.id} | ${user.department}</div>
                </li>
            `).join('');
        }

        // åˆ‡æ¢ç”¨æˆ·
        async function switchUser(userId) {
            try {
                const user = USERS.find(u => u.id === userId);
                if (!user) {
                    throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
                }

                // æ›´æ–°å½“å‰ç”¨æˆ·
                currentUser = user;
                
                // æ›´æ–°UIçŠ¶æ€
                updateUserSelection(userId);
                updateChatHeader(user);
                
                // åµŒå…¥èŠå¤©çª—å£
                await chatIntegration.embedUserChat('chat-container', user.id, user.name);
                
                // æ›´æ–°ä¼šè¯ä¿¡æ¯
                updateSessionInfo(user);
                
                console.log(`å·²åˆ‡æ¢åˆ°ç”¨æˆ·: ${user.name} (${user.id})`);
            } catch (error) {
                console.error('åˆ‡æ¢ç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ‡æ¢ç”¨æˆ·å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°ç”¨æˆ·é€‰æ‹©çŠ¶æ€
        function updateUserSelection(selectedUserId) {
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[onclick="switchUser('${selectedUserId}')"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            document.getElementById('current-user-name').textContent = 
                currentUser ? `${currentUser.name} (${currentUser.department})` : 'è¯·é€‰æ‹©ç”¨æˆ·';
        }

        // æ›´æ–°èŠå¤©å¤´éƒ¨
        function updateChatHeader(user) {
            document.getElementById('chat-title').textContent = `${user.name} çš„ä¸“å±æ™ºèƒ½åŠ©æ‰‹`;
            document.getElementById('chat-subtitle').textContent = `${user.department} | ç”¨æˆ·ID: ${user.id}`;
        }

        // æ›´æ–°ä¼šè¯ä¿¡æ¯
        function updateSessionInfo(user) {
            const sessionInfo = document.getElementById('session-info');
            sessionInfo.innerHTML = `
                ä¼šè¯ID: session_${user.id}_${Date.now()}<br>
                åˆ›å»ºæ—¶é—´: ${new Date().toLocaleString()}
            `;
        }

        // åˆ·æ–°èŠå¤©
        async function refreshChat() {
            if (currentUser) {
                await switchUser(currentUser.id);
            } else {
                alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // æ¨¡æ‹Ÿå®é™…APIè°ƒç”¨çš„å‡½æ•°ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        async function createRealUserSession(userId, userName) {
            try {
                const response = await fetch(`${CONFIG.baseURL}/api/v1/chats/${CONFIG.chatId}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        name: `${userName}çš„èŠå¤©ä¼šè¯`,
                        user_id: userId
                    })
                });

                const result = await response.json();
                
                if (result.code === 0) {
                    return {
                        success: true,
                        sessionId: result.data.id,
                        sessionName: result.data.name
                    };
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                return { success: false, error: error.message };
            }
        }
    </script>
</body>
</html> 